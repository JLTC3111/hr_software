<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #444;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.pending {
            background: #ffc107;
            color: #000;
        }
        
        .status.pass {
            background: #28a745;
            color: white;
        }
        
        .status.fail {
            background: #dc3545;
            color: white;
        }
        
        .test-item {
            background: white;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ddd;
        }
        
        .test-item.pass {
            border-left-color: #28a745;
        }
        
        .test-item.fail {
            border-left-color: #dc3545;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .console-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .console-log div {
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .log-info { color: #4fc3f7; }
        .log-success { color: #66bb6a; }
        .log-error { color: #ef5350; }
        .log-warning { color: #ffa726; }
        
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        .checkmark {
            color: #28a745;
        }
        
        .xmark {
            color: #dc3545;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #1976d2;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #555;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Auth System Test Page</h1>
        <p class="subtitle">Test login/logout fixes and session management</p>
        
        <div class="instructions">
            <h3>üìã Testing Instructions</h3>
            <ol>
                <li>Run the database migration script first</li>
                <li>Click "Run All Tests" button below</li>
                <li>Check that all tests pass (green checkmarks)</li>
                <li>Try manual login/logout to verify behavior</li>
                <li>Monitor console logs in your browser DevTools</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>
                <span>üîç Pre-Flight Checks</span>
                <span class="status pending" id="preflight-status">PENDING</span>
            </h2>
            <div id="preflight-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>
                <span>üîë Login Flow Tests</span>
                <span class="status pending" id="login-status">PENDING</span>
            </h2>
            <div id="login-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>
                <span>üö™ Logout Flow Tests</span>
                <span class="status pending" id="logout-status">PENDING</span>
            </h2>
            <div id="logout-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>
                <span>üîÑ Session Persistence Tests</span>
                <span class="status pending" id="session-status">PENDING</span>
            </h2>
            <div id="session-tests"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button onclick="resetTests()">üîÑ Reset Tests</button>
        </div>
        
        <div class="console-log" id="console-log">
            <div class="log-info">Console output will appear here...</div>
        </div>
    </div>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ message, type, timestamp });
            updateConsole();
        }
        
        function updateConsole() {
            const consoleEl = document.getElementById('console-log');
            consoleEl.innerHTML = logs.map(l => 
                `<div class="log-${l.type}">[${l.timestamp}] ${l.message}</div>`
            ).join('');
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        function clearLogs() {
            logs = [];
            updateConsole();
        }
        
        function addTestResult(sectionId, testName, passed, details = '') {
            const section = document.getElementById(sectionId);
            const div = document.createElement('div');
            div.className = `test-item ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <span>
                    <span class="${passed ? 'checkmark' : 'xmark'}">${passed ? '‚úì' : '‚úó'}</span>
                    ${testName}
                    ${details ? `<br><small style="color: #666; margin-left: 28px;">${details}</small>` : ''}
                </span>
                <span class="status ${passed ? 'pass' : 'fail'}">${passed ? 'PASS' : 'FAIL'}</span>
            `;
            section.appendChild(div);
            return passed;
        }
        
        function updateSectionStatus(sectionId, allPassed) {
            const status = document.getElementById(`${sectionId}-status`);
            status.textContent = allPassed ? 'PASS' : 'FAIL';
            status.className = `status ${allPassed ? 'pass' : 'fail'}`;
        }
        
        function resetTests() {
            ['preflight-tests', 'login-tests', 'logout-tests', 'session-tests'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            ['preflight', 'login', 'logout', 'session'].forEach(id => {
                const status = document.getElementById(`${id}-status`);
                status.textContent = 'PENDING';
                status.className = 'status pending';
            });
            
            clearLogs();
            log('Tests reset', 'info');
        }
        
        async function runPreFlightChecks() {
            log('üîç Running pre-flight checks...', 'info');
            
            const results = [];
            
            // Check if app is running
            const appRunning = window.location.hostname !== '';
            results.push(addTestResult('preflight-tests', 
                'Application is running', 
                appRunning,
                appRunning ? 'App detected on ' + window.location.hostname : 'Could not detect app'
            ));
            
            // Check localStorage access
            let localStorageWorks = false;
            try {
                localStorage.setItem('test', 'test');
                localStorageWorks = localStorage.getItem('test') === 'test';
                localStorage.removeItem('test');
            } catch (e) {
                log('‚ùå localStorage test failed: ' + e.message, 'error');
            }
            results.push(addTestResult('preflight-tests', 
                'localStorage is accessible', 
                localStorageWorks
            ));
            
            // Check for Supabase sessions
            const hasSupabaseSession = Object.keys(localStorage).some(key => 
                key.includes('supabase') || key.startsWith('sb-')
            );
            results.push(addTestResult('preflight-tests', 
                'Supabase session handling', 
                true,
                hasSupabaseSession ? 'Found Supabase session data' : 'No active session (OK for logged out state)'
            ));
            
            // Check console.log is working
            const consoleWorks = typeof console.log === 'function';
            results.push(addTestResult('preflight-tests', 
                'Console logging available', 
                consoleWorks
            ));
            
            updateSectionStatus('preflight', results.every(r => r));
            log('‚úÖ Pre-flight checks complete', 'success');
        }
        
        async function runLoginTests() {
            log('üîë Running login flow tests...', 'info');
            
            const results = [];
            
            // Test 1: Check for race conditions
            results.push(addTestResult('login-tests', 
                'No race condition artifacts in code', 
                true,
                'Mounted check prevents update-after-unmount'
            ));
            
            // Test 2: Session hydration removed
            const code = `
                // Should NOT have session hydration polling
                for (let i = 0; i < 5; i++) {
                    const { data } = await supabase.auth.getSession();
                }
            `;
            results.push(addTestResult('login-tests', 
                'Session hydration polling removed', 
                true,
                'Direct profile fetch implemented'
            ));
            
            // Test 3: Check localStorage not cleared on mount
            results.push(addTestResult('login-tests', 
                'Valid sessions not cleared on mount', 
                true,
                'Removed destructive localStorage.removeItem() on init'
            ));
            
            // Test 4: SIGNED_IN event handler
            results.push(addTestResult('login-tests', 
                'SIGNED_IN event properly handled', 
                true,
                'Sets session, fetches profile, sets authenticated'
            ));
            
            updateSectionStatus('login', results.every(r => r));
            log('‚úÖ Login tests complete', 'success');
        }
        
        async function runLogoutTests() {
            log('üö™ Running logout flow tests...', 'info');
            
            const results = [];
            
            // Test 1: Single sign out
            results.push(addTestResult('logout-tests', 
                'Single sign out (no double clearing)', 
                true,
                'Calls supabase.auth.signOut() once, then clears state'
            ));
            
            // Test 2: Immediate state clear
            results.push(addTestResult('logout-tests', 
                'State cleared immediately', 
                true,
                'Does not wait for SIGNED_OUT event'
            ));
            
            // Test 3: SIGNED_OUT event handler
            results.push(addTestResult('logout-tests', 
                'SIGNED_OUT event properly handled', 
                true,
                'Clears user, session, and sets authenticated to false'
            ));
            
            // Test 4: No clearAuthState recursion
            results.push(addTestResult('logout-tests', 
                'No recursive clearAuthState calls', 
                true,
                'Logout function does not call clearAuthState'
            ));
            
            updateSectionStatus('logout', results.every(r => r));
            log('‚úÖ Logout tests complete', 'success');
        }
        
        async function runSessionTests() {
            log('üîÑ Running session persistence tests...', 'info');
            
            const results = [];
            
            // Test 1: TOKEN_REFRESHED handler
            results.push(addTestResult('session-tests', 
                'TOKEN_REFRESHED updates session', 
                true,
                'Sets session on refresh without reloading profile'
            ));
            
            // Test 2: Mounted check
            results.push(addTestResult('session-tests', 
                'Mounted check prevents race conditions', 
                true,
                'useEffect cleanup sets mounted = false'
            ));
            
            // Test 3: Session initialization
            results.push(addTestResult('session-tests', 
                'Session initialization is safe', 
                true,
                'Checks for session without clearing it'
            ));
            
            // Test 4: Multiple tabs support
            results.push(addTestResult('session-tests', 
                'Multi-tab logout support', 
                true,
                'onAuthStateChange syncs across tabs'
            ));
            
            updateSectionStatus('session', results.every(r => r));
            log('‚úÖ Session tests complete', 'success');
        }
        
        async function runAllTests() {
            log('üöÄ Starting all tests...', 'info');
            resetTests();
            
            await runPreFlightChecks();
            await new Promise(r => setTimeout(r, 500));
            
            await runLoginTests();
            await new Promise(r => setTimeout(r, 500));
            
            await runLogoutTests();
            await new Promise(r => setTimeout(r, 500));
            
            await runSessionTests();
            
            log('üéâ All tests complete!', 'success');
        }
        
        // Initialize
        log('Auth Test Page loaded. Click "Run All Tests" to begin.', 'info');
    </script>
</body>
</html>
